# nixpacks.toml
# Build configuration for the listmonk project using Nixpacks.
# This repository contains a Go backend and a Vue/Node frontend.
# The Makefile already knows how to compile everything and embed
# all of the static assets into a single binary via `make dist`.

# Providers are used to detect languages and pull in default
# build plans.  Since we have both Go and Node code, include both.
providers = ["go", "node"]

[phases.setup]
# Extend the provider's default packages rather than replacing them.
# The provider already pulls in Go and a Node runtime; we need to
# bump Node to 20 and add some tooling.
#
# The "..." entry tells Nixpacks to keep whatever the provider supplied.
# This avoids undefined-symbol errors like the earlier `go_1_24` issue.
nixPkgs = [
  "...",
  # provider supplies a nodejs package (v18 at time of writing).
  # If you truly need NodeÂ 20 you could pin the build image to a newer
  # nixpkgs release or add the correct package name once available.
  "yarn",         # used by the make targets
  "git",          # frontend build references .gitignore
  "curl",         # scripts may fetch things with curl
]

# apt packages are still available for legacy commands executed by
# make dist (the Dockerfile originally installed curl with apt).
aptPkgs = ["curl"]

[phases.build]
# `make dist` handles the entire build: compiles the backend, runs both
# frontends, and bundles assets into the binary via stuffbin.  When the
# binary is built successfully, no additional files are required at runtime.
#
# The email-builder make rule depends on the node_modules directory, which
# may already exist as an empty folder because we mount the cache.  To avoid
# 'vite: not found' errors, run yarn install explicitly before invoking make.
# The same applies to the main frontend.
cmds = [
  # Ensure devDependencies (eslint, vite, etc.) are installed so the
  # --fix lint step can run in the build image. Yarn defaults to
  # production installs in some environments, so force dev deps too.
  "cd frontend/email-builder && yarn install --production=false",
  "cd frontend && yarn install --production=false",
  # Run eslint --fix to automatically correct simple lint issues so the
  # production build doesn't fail on stylistic problems. If fixes can't be
  # applied, continue (|| true) and let the build proceed; CI should surface
  # remaining lint issues for developers to address.
  "cd frontend && ./node_modules/.bin/eslint --ext .js,.vue --ignore-path .gitignore src --fix || true",
  # Now run the full packaging target. Avoid disabling lifecycle scripts so
  # frontend build runs normally (we pre-fixed issues above).
  "make dist",
]

# Cache node modules between builds to speed up subsequent executions.
cacheDirectories = [
  "frontend/node_modules",
  "frontend/email-builder/node_modules",
]

[start]
# When the image is run, simply execute the compiled binary.  In a
# production deployment you can supply additional flags or environment
# variables via Easypanel/railway/etc.
cmd = "./listmonk"

# Optionally specify a lightweight runtime image; the default is the
# same as the build image.  We can leave it unset since the binary is
# statically linked (CGO_ENABLED=0) and thus can run on alpine.
# runImage = "alpine:latest"
